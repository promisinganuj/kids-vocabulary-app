# â”€â”€â”€ Azure Container App â€“ CI/CD Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Builds and deploys the Kids Vocabulary App to Azure Container Apps.
#
# Triggers:
#   - Push to 'main' branch (app/ or infra/ changes)
#   - Manual dispatch with optional image tag
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS          â€” Service principal JSON (az ad sp create-for-rbac --sdk-auth)
#   SECRET_KEY                 â€” App session secret key
#
# Optional GitHub Secrets:
#   AZURE_OPENAI_API_KEY       â€” Azure OpenAI API key
#   AZURE_OPENAI_ENDPOINT      â€” Azure OpenAI endpoint URL
#   AZURE_OPENAI_DEPLOYMENT    â€” Azure OpenAI deployment name
#
# Required GitHub Variables:
#   RESOURCE_GROUP             â€” Azure resource group  (default: rg-kids-vocab)
#   LOCATION                   â€” Azure region          (default: australiaeast)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Deploy to Azure Container Apps

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'infra/**'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: git SHA)'
        required: false
        default: ''

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP || 'rg-kids-vocab' }}
  LOCATION: ${{ vars.LOCATION || 'australiaeast' }}
  APP_NAME: kids-vocab

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      # â”€â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€â”€ Azure Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # â”€â”€â”€ Determine image tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set image tag
        id: tag
        run: |
          if [[ -n "${{ github.event.inputs.image_tag }}" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_OUTPUT"
          fi

      # â”€â”€â”€ Deploy Infrastructure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create resource group
        run: |
          az group create \
            --name "${{ env.RESOURCE_GROUP }}" \
            --location "${{ env.LOCATION }}" \
            --output none

      - name: Deploy Bicep infrastructure
        id: infra
        run: |
          OUTPUT=$(az deployment group create \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.json \
            --parameters \
              secretKey="${{ secrets.SECRET_KEY }}" \
              imageTag="${{ steps.tag.outputs.tag }}" \
              azureOpenaiApiKey="${{ secrets.AZURE_OPENAI_API_KEY }}" \
              azureOpenaiEndpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
              azureOpenaiDeployment="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
            --query "properties.outputs" \
            --output json)

          echo "acr_name=$(echo $OUTPUT | jq -r '.acrName.value')" >> "$GITHUB_OUTPUT"
          echo "acr_server=$(echo $OUTPUT | jq -r '.acrLoginServer.value')" >> "$GITHUB_OUTPUT"
          echo "app_name=$(echo $OUTPUT | jq -r '.containerAppName.value')" >> "$GITHUB_OUTPUT"
          echo "app_url=$(echo $OUTPUT | jq -r '.appUrl.value')" >> "$GITHUB_OUTPUT"

      # â”€â”€â”€ Build & Push Container Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login to ACR
        run: az acr login --name "${{ steps.infra.outputs.acr_name }}"

      - name: Build and push image
        run: |
          IMAGE="${{ steps.infra.outputs.acr_server }}/${{ env.APP_NAME }}"

          docker build \
            -t "$IMAGE:${{ steps.tag.outputs.tag }}" \
            -t "$IMAGE:latest" \
            -f app/Dockerfile \
            app/

          docker push "$IMAGE:${{ steps.tag.outputs.tag }}"
          docker push "$IMAGE:latest"

      # â”€â”€â”€ Update Container App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy new image to Container App
        run: |
          az containerapp update \
            --name "${{ steps.infra.outputs.app_name }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${{ steps.infra.outputs.acr_server }}/${{ env.APP_NAME }}:${{ steps.tag.outputs.tag }}" \
            --output none

      # â”€â”€â”€ Verify Deployment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          APP_URL="${{ steps.infra.outputs.app_url }}"
          echo "Checking health at $APP_URL/health ..."

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" --max-time 30 || echo "000")

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Deployment healthy! App is live at $APP_URL"
          else
            echo "âš ï¸  Health check returned HTTP $HTTP_CODE (app may still be starting)"
            echo "    Check logs: az containerapp logs show --name ${{ steps.infra.outputs.app_name }} --resource-group ${{ env.RESOURCE_GROUP }} --follow"
          fi

      # â”€â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **App URL** | ${{ steps.infra.outputs.app_url }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Image Tag** | \`${{ steps.tag.outputs.tag }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Container App** | \`${{ steps.infra.outputs.app_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Resource Group** | \`${{ env.RESOURCE_GROUP }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Registry** | \`${{ steps.infra.outputs.acr_server }}\` |" >> "$GITHUB_STEP_SUMMARY"
